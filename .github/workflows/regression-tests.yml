name: ðŸ§ª DomainDrip.AI Regression Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 6 AM UTC to catch regressions early
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      skip_e2e:
        description: 'Skip E2E tests'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'
  CONTINUE_ON_FAIL: true

jobs:
  
  # Unit and Integration Tests
  unit-integration-tests:
    name: ðŸ”¬ Unit & Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ§ª Run unit tests
        run: npm run test:unit
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          
      - name: ðŸ”— Run integration tests
        run: npm run test:integration
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          
      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-integration-test-results
          path: |
            test-results/
            coverage/
          
  # Component Tests
  component-tests:
    name: âš›ï¸ React Component Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ§ª Run component tests
        run: npm run test:components
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          
      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: component-test-results
          path: test-results/
          
  # Database Tests
  database-tests:
    name: ðŸ—„ï¸ Database & Logging Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ§ª Run database tests
        run: npm run test:database
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          
      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: database-test-results
          path: test-results/
          
  # E2E Tests
  e2e-tests:
    name: ðŸŽ­ End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.inputs.skip_e2e != 'true'
    
    steps:
      - name: ðŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps
          
      - name: ðŸ—ï¸ Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          
      - name: ðŸš€ Start preview server
        run: |
          npm run preview &
          sleep 10
          
      - name: ðŸ§ª Run E2E tests
        run: npm run test:e2e
        env:
          E2E_BASE_URL: http://localhost:4173
          CI: true
          
      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/
            
  # Comprehensive Regression Suite
  regression-suite:
    name: ðŸš€ Full Regression Suite
    runs-on: ubuntu-latest
    needs: [unit-integration-tests, component-tests, database-tests]
    timeout-minutes: 25
    
    steps:
      - name: ðŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ—ï¸ Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          
      - name: ðŸ§ª Run comprehensive regression suite
        run: npm run test:ci
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SKIP_E2E: ${{ github.event.inputs.skip_e2e }}
          CI: true
          
      - name: ðŸ“Š Generate test report
        if: always()
        run: |
          echo "# ðŸ§ª DomainDrip.AI Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ ${{ job.status }} == "success" ]; then
            echo "âœ… **All tests passed!** Ready for production deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Tests failed.** Review failures before deployment." >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: ðŸ“Š Upload comprehensive results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: regression-test-results
          path: |
            test-results/
            coverage/
            playwright-report/
            
  # Validation Log Analysis
  log-validation:
    name: ðŸ“Š Validation Log Analysis  
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ” Analyze validation logs
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          
          const supabase = createClient(
            process.env.VITE_SUPABASE_URL,
            process.env.SUPABASE_SERVICE_ROLE_KEY
          );
          
          async function analyzeRecentLogs() {
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000);
            
            const { data: recentLogs } = await supabase
              .from('validation_logs')
              .select('*')
              .gte('created_at', yesterday.toISOString())
              .order('created_at', { ascending: false });
              
            console.log('ðŸ“Š Recent Validation Logs (24h):');
            console.log('Total entries:', recentLogs?.length || 0);
            
            if (recentLogs?.length > 0) {
              const bySource = recentLogs.reduce((acc, log) => {
                acc[log.source] = (acc[log.source] || 0) + 1;
                return acc;
              }, {});
              
              console.log('By source:', JSON.stringify(bySource, null, 2));
              
              const errorLogs = recentLogs.filter(log => 
                log.status === 'error' || log.status === 'mismatch'
              );
              
              if (errorLogs.length > 0) {
                console.log('âš ï¸ Error/Mismatch logs found:', errorLogs.length);
                errorLogs.slice(0, 5).forEach(log => {
                  console.log(\`- \${log.domain}: \${log.message}\`);
                });
              } else {
                console.log('âœ… No error logs in past 24h');
              }
            }
          }
          
          analyzeRecentLogs().catch(console.error);
          "
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          
  # Deployment Readiness Check
  deployment-readiness:
    name: ðŸš€ Deployment Readiness
    runs-on: ubuntu-latest
    needs: [regression-suite, e2e-tests]
    if: always()
    
    steps:
      - name: ðŸŽ¯ Check deployment readiness
        run: |
          echo "# ðŸš€ Deployment Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          REGRESSION_STATUS="${{ needs.regression-suite.result }}"
          E2E_STATUS="${{ needs.e2e-tests.result }}"
          
          if [[ "$REGRESSION_STATUS" == "success" && ("$E2E_STATUS" == "success" || "$E2E_STATUS" == "skipped") ]]; then
            echo "## âœ… READY FOR DEPLOYMENT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY  
            echo "All critical tests passed. Safe to deploy to production." >> $GITHUB_STEP_SUMMARY
            echo "- Zero false positives detected" >> $GITHUB_STEP_SUMMARY
            echo "- Buy link validation working" >> $GITHUB_STEP_SUMMARY
            echo "- Domain availability logic verified" >> $GITHUB_STEP_SUMMARY
            echo "- Logging system operational" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ NOT READY FOR DEPLOYMENT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Critical test failures detected. Review required before deployment." >> $GITHUB_STEP_SUMMARY
            echo "- Regression Suite: $REGRESSION_STATUS" >> $GITHUB_STEP_SUMMARY
            echo "- E2E Tests: $E2E_STATUS" >> $GITHUB_STEP_SUMMARY
          fi